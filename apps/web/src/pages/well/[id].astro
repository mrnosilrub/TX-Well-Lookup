---
import { wells as stubWells } from '../../lib/stubWells';
import NearbyEnergy from '../../components/NearbyEnergy.astro';
export function getStaticPaths() {
  return stubWells.map((w) => ({ params: { id: w.id } }));
}
const { id } = Astro.params;
const base = (import.meta.env.PUBLIC_BASE_PATH || '/').replace(/\/?$/, '/');
const well = stubWells.find((w) => w.id === id);
const title = `Well ${id}`;
const publicApi = import.meta.env.PUBLIC_API_URL || '';
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <base href={base} />
    <style>
      :root { --ink:#0b0b0c; --bg:#f6f7f9; --card:#fff; --muted:#6b7280; }
      html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
      header{position:sticky;top:0;background:var(--card);border-bottom:1px solid #e5e7eb}
      .wrap{max-width:1000px;margin:0 auto;padding:16px}
      .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:18px}
      .btn{background:#111;color:#fff;border-radius:10px;padding:10px 14px;text-decoration:none}
      small{color:var(--muted)}
      .modal{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center}
      .modal > div{background:#fff;border-radius:12px;padding:20px;max-width:420px}
      .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
      .chip{background:#eef2ff;border:1px solid #c7d2fe;color:#312e81;border-radius:999px;padding:6px 10px;font-size:12px}
    </style>
  </head>
  <body>
    <header>
      <div class="wrap" style="display:flex;gap:12px;align-items:center;">
        <strong>TX Well Lookup</strong>
        <nav style="margin-left:auto;display:flex;gap:12px;align-items:center;">
          <a href={base}>Home</a>
        </nav>
      </div>
    </header>
    <main class="wrap" style="padding-block:24px">
      {well ? (
        <section class="card" data-api={publicApi}>
          <h2>{well.name}</h2>
          <div class="chips">
            <span class="chip">County: {well.county}</span>
            <span class="chip">Depth: {well.depth_ft} ft</span>
            {well.aquifer && <span class="chip">Aquifer: {well.aquifer}</span>}
            {well.gcd && <span class="chip">GCD: {well.gcd}</span>}
            {well.gwdb_depth_ft && <span class="chip">GWDB: {well.gwdb_depth_ft} ft</span>}
          </div>
          <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
            <button id="btn-report" class="btn">Generate Report</button>
            <span id="report-status"><small>Idle</small></span>
          </div>
        </section>
        <NearbyEnergy lat={well.lat} lon={well.lon} />
      ) : (
        <section class="card"><p>Well not found.</p></section>
      )}

      <div class="modal" id="paywall">
        <div>
          <h3>Buy credits</h3>
          <p><small>This is a stubbed paywall. Close to continue.</small></p>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="close-paywall" class="btn">Close</button>
          </div>
        </div>
      </div>
    </main>
    <script is:inline>
      const btn = document.getElementById('btn-report');
      const status = document.getElementById('report-status');
      const modal = document.getElementById('paywall');
      const close = document.getElementById('close-paywall');
      const container = document.currentScript.closest('section');
      const apiBase = (container?.dataset.api || '').toString().trim();
      function showModal(){ modal.style.display='flex'; }
      function hideModal(){ modal.style.display='none'; }
      close?.addEventListener('click', hideModal);
      async function postReport(){
        const url = apiBase
          ? new URL('v1/reports', apiBase.endsWith('/') ? apiBase : apiBase + '/').toString()
          : new URL('/v1/reports', window.location.origin).toString();
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ well_id: "{id}" }) });
        if (res.status === 402) throw new Error('402');
        if (!res.ok) throw new Error('bad');
        const data = await res.json();
        return data.report_id;
      }
      async function pollReport(reportId){
        const url = apiBase
          ? new URL(`v1/reports/${reportId}`, apiBase.endsWith('/') ? apiBase : apiBase + '/').toString()
          : new URL(`/v1/reports/${reportId}`, window.location.origin).toString();
        for (let i=0;i<10;i++){
          const res = await fetch(url, { cache: 'no-store' });
          if (res.ok){
            const data = await res.json();
            if (data && (data.pdf_url || data.zip_url)) return data;
          }
          await new Promise(r => setTimeout(r, 800));
        }
        throw new Error('timeout');
      }
      btn?.addEventListener('click', async () => {
        try{
          status.innerHTML = '<small>Requesting…</small>';
          const reportId = await postReport();
          status.innerHTML = '<small>Generating…</small>';
          const data = await pollReport(reportId);
          const pdfUrl = data.pdf_url ? new URL(data.pdf_url, document.baseURI).toString() : new URL('fake/report.pdf', document.baseURI).toString();
          const zipUrl = data.zip_url ? new URL(data.zip_url, document.baseURI).toString() : '';
          status.innerHTML = `<small>Ready:</small> <a class=\"btn\" href=\"${pdfUrl}\">PDF</a>${zipUrl ? ` <a class=\"btn\" href=\"${zipUrl}\">ZIP</a>` : ''}`;
        } catch(e){
          if ((e && e.message) === '402'){
            status.innerHTML = '<small>Payment required</small>';
            showModal();
            return;
          }
          const fallback = new URL('fake/report.pdf', document.baseURI).toString();
          status.innerHTML = `<small>Ready:</small> <a class=\"btn\" href=\"${fallback}\">PDF</a>`;
        }
      });
    </script>
  </body>
  </html>


