---
const PUBLIC_API_URL = import.meta.env.PUBLIC_API_URL || 'http://127.0.0.1:8001';
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TX Well Lookup</title>
    <meta name="x-api" content={PUBLIC_API_URL} />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    
    <style>
      /* ALIGNMENT FIX v4 - Global rules */
      :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--accent:#38bdf8;--line:#1f2937;--text:#e2e8f0;--cell-pad:12px}
      [data-theme='dark']{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--accent:#38bdf8;--line:#1f2937;--text:#e2e8f0}
      [data-theme='light']{--bg:#f8fafc;--panel:#ffffff;--muted:#4b5563;--accent:#2563eb;--line:#e5e7eb;--text:#111827}
      *{box-sizing:border-box}
      /* Global rule to shift all tbody td content */
      :global(tbody td) { padding-left: calc(var(--cell-pad) + 2px) !important; }
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text);display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
      header, footer{padding:16px 20px;border-bottom:1px solid var(--line);background:var(--panel);color:var(--text)}
      header strong{letter-spacing:0.3px}
      .app{display:grid;grid-template-columns:360px minmax(0,1fr);gap:0}
      .sidebar{border-right:1px solid var(--line);padding:18px 16px 24px;background:var(--panel);position:relative;z-index:3;isolation:isolate}
      #filters{display:flex;flex-direction:column;gap:12px;width:100%}
      .content{display:grid;grid-template-rows:minmax(360px,1fr) 240px;position:relative;z-index:1}
      .map{min-height:360px;position:relative;z-index:0}
      .results{border-top:1px solid var(--line);overflow-y:auto;overflow-x:hidden;background:var(--panel)}
      /* Account for scrollbar width to keep header/body columns aligned */
      .results{--sbw: calc( var(--_sbw, 0px) );}
      @supports selector(::-webkit-scrollbar){
        .results{ --_sbw: 0px; }
      }
      @supports not selector(::-webkit-scrollbar){
        .results{ --_sbw: 0px; }
      }
      label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
      input, select{width:100%;padding:10px;margin-top:6px;border:1px solid var(--line);border-radius:10px;background:var(--panel);color:var(--text)}
      [data-theme='light'] input, [data-theme='light'] select{color:#000 !important}
      input:focus, select:focus, button:focus{outline:2px solid var(--accent);outline-offset:2px}
      .btns{display:flex;gap:10px}
      button{margin-top:14px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text);cursor:pointer}
      button:hover{border-color:var(--accent);background:color-mix(in srgb, var(--panel) 90%, var(--accent))}
      #theme{margin-top:0;padding:8px 10px;border-radius:8px;line-height:1;display:inline-flex;align-items:center;gap:6px;background:var(--panel);color:var(--text);border:1px solid var(--line)}
      #exportCsv, #exportPdf{margin-top:0;padding:8px 10px;border-radius:8px;line-height:1;display:inline-flex;align-items:center;background:var(--panel);color:var(--text);border:1px solid var(--line)}
      #exportCsv:hover, #exportPdf:hover{border-color:var(--accent);background:color-mix(in srgb, var(--panel) 90%, var(--accent))}
      table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px;color:var(--text)}
      thead{position:sticky;top:0;background:var(--panel);z-index:1;padding-right:var(--sbw, 0px)}
      th{padding:12px var(--cell-pad);border-bottom:1px solid var(--line);vertical-align:middle;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
      /* Header base x; body text nudged ~5px using padding so it always shows */
      thead th{padding-left:var(--cell-pad) !important}
      tbody td{padding-left:calc(var(--cell-pad) + 5px) !important}
      /* Remove any group shift that could cause horizontal scroll */
      tbody{transform:none}
      td{padding:12px var(--cell-pad);border-bottom:1px solid var(--line);vertical-align:middle;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;position:relative}
      /* remove legacy inner span adjustment */
      .cell{display:initial;padding-left:0}
      th.sortable{cursor:pointer}
      th.sortable::after{content:'';margin-left:4px;font-size:10px;opacity:.7}
      thead tr:hover th{background:color-mix(in srgb, var(--panel) 90%, var(--accent) 10%)}
      .sortable[data-sort="asc"]::after{content:'\25B2'}
      .sortable[data-sort="desc"]::after{content:'\25BC'}
      tbody tr{cursor:pointer}
      tbody tr:hover{background:color-mix(in srgb, var(--accent) 15%, var(--panel))}
      tr.row-active{background:color-mix(in srgb, var(--panel) 85%, var(--accent) 15%)}
      tr.row-active:first-child{border-left:3px solid var(--accent)}
      #status{padding:8px 12px;color:var(--muted);font-size:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;background:var(--panel)}
      .spinner{width:14px;height:14px;border:2px solid #334155;border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
      @keyframes spin{to{transform:rotate(360deg)}}
      .toggle{display:flex;align-items:flex-start;gap:10px;margin-top:14px;color:var(--text);flex-wrap:wrap}
      .toggle input{flex:0 0 auto;margin-top:2px}
      .toggle span{flex:1 1 auto;color:var(--text);font-size:14px;display:block;line-height:1.4;white-space:normal;max-width:100%}
      .banner{padding:10px 12px;background:#421e1e;color:#fecaca;border-bottom:1px solid #7f1d1d;display:none}
      .banner.show{display:block}
      #mapOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.15);z-index:5}
      #mapOverlay.show{display:flex}
      @media (max-width: 900px){
        .app{grid-template-columns:1fr}
        .sidebar{border-right:0;border-bottom:1px solid var(--line)}
        .content{grid-template-rows:300px auto}
      }
      @media (min-width: 900px){
        html, body{height:100vh;overflow:hidden}
        .sidebar{overflow:auto}
        .results{overflow:auto}
      }
      /* Marker highlight */
      .leaflet-marker-icon.selected{transform:scale(1.12);filter:drop-shadow(0 0 8px rgba(56,189,248,0.7));}
      [data-theme='light'] .date-cell{color:#000 !important}
      [data-theme='dark'] .date-cell{color:var(--text)}
      
    </style>
  </head>
  <body>
    <header>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <strong>TX Well Lookup</strong>
        <div style="display:flex;align-items:center;gap:12px">
          <span id="asof" style="font-size:12px;color:var(--muted)"></span>
          <button id="exportCsv" type="button" aria-label="Export CSV">Export CSV</button>
          <button id="exportPdf" type="button" aria-label="Export PDF">Export PDF</button>
          <button id="theme" type="button" aria-label="Toggle theme">Toggle theme</button>
        </div>
      </div>
    </header>
    <div class="app">
      <div class="sidebar">
        <form id="filters">
          <label>County
            <input name="county" placeholder="e.g., Galveston" />
          </label>
          <label>Address or place (optional)
            <input name="addr" placeholder="e.g., 100 Congress Ave, Austin" />
          </label>
          <div class="btns">
            <button type="button" id="geocode">Find address</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <label>Depth min (ft)
                <input name="depth_min" type="number" />
              </label>
            </div>
            <div>
              <label>Depth max (ft)
                <input name="depth_max" type="number" />
              </label>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <label>Date from
                <input name="date_from" type="date" />
              </label>
            </div>
            <div>
              <label>Date to
                <input name="date_to" type="date" />
              </label>
            </div>
          </div>
          <div class="btns">
            <button type="submit">Apply</button>
            <button type="button" id="reset">Reset</button>
          </div>
          <div class="toggle">
            <input id="use_radius" type="checkbox" />
            <span>Enable radius search around map center</span>
          </div>
          <label>Radius (meters)
            <input name="radius_m" type="number" value="1609" />
          </label>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Tip: click on the map to set the center when radius is enabled.</div>
        </form>
      </div>
      <div class="content">
        <div id="map" class="map"><div id="mapOverlay"><span class="spinner"></span></div></div>
        <div class="results">
          <div id="banner" class="banner" role="alert"></div>
          <div id="status" aria-live="polite">Ready</div>
          <table>
            <colgroup>
              <col style="width:10%"><col style="width:42%"><col style="width:16%"><col style="width:16%"><col style="width:16%">
            </colgroup>
            <thead>
              <tr>
                <th data-key="id" class="sortable">Well ID</th>
                <th data-key="owner" class="sortable">Owner</th>
                <th data-key="county" class="sortable">County</th>
                <th data-key="depth_ft" class="sortable">Depth (ft)</th>
                <th data-key="date_completed" class="sortable">Completed</th>
              </tr>
            </thead>
            <tbody id="rows">
            </tbody>
          </table>
          <div id="pager" style="display:flex;align-items:center;gap:10px;padding:10px;border-top:1px solid var(--line)">
            <button id="prev" type="button">Prev</button>
            <span id="pageinfo" style="font-size:12px;color:var(--muted)"></span>
            <button id="next" type="button">Next</button>
          </div>
        </div>
      </div>
    </div>
    <footer>
      Contains data from TWDB SDR. For reference use only.
    </footer>
    <script type="module">
      const L = window.L;
      // Read API base URL from meta tag injected by Astro
      const API = (document.querySelector('meta[name="x-api"]')?.getAttribute('content')) || 'http://127.0.0.1:8001';
      const map = L.map('map').setView([31.0, -99.0], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
      let markers = [];
      const markersById = new Map();
      let centerMarker = null;
      let radiusCircle = null;
      let selectedCenter = null;
      let suppressFitBounds = false;
      let allRows = [];
      let pageSize = 25;
      let page = 1;
      let sortKey = 'date_completed';
      let sortDir = 'desc';
      function updateSortIndicators(){
        document.querySelectorAll('th.sortable').forEach(th => {
          const key = th.getAttribute('data-key');
          if(!key) return;
          if(key === sortKey){ th.setAttribute('data-sort', sortDir); }
          else { th.removeAttribute('data-sort'); }
        });
      }
      function renderPage(){
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        const slice = allRows.slice(start, end);
        renderRows(slice);
        const pages = Math.max(1, Math.ceil(allRows.length / pageSize));
        const info = document.getElementById('pageinfo');
        if(info){ info.textContent = `Page ${page} of ${pages} (${allRows.length} total)`; }
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        if(prevBtn) prevBtn.disabled = page <= 1;
        if(nextBtn) nextBtn.disabled = page >= pages;
        // ensure header and cells stay aligned on resize
        requestAnimationFrame(() => {
          const table = document.querySelector('table');
          if(table && table.offsetWidth){ table.style.tableLayout = 'fixed'; }
        });
      }
      function setStatus(text, loading=false){
        const el = document.getElementById('status');
        el.innerHTML = '';
        if(loading){ const s = document.createElement('span'); s.className='spinner'; el.appendChild(s); }
        el.appendChild(document.createTextNode(text));
      }

      async function fetchResults(params){
        const url = new URL('/v1/search', API);
        Object.entries(params).forEach(([k,v]) => { if(v!=='' && v!=null) url.searchParams.set(k, v); });
        const res = await fetch(url, { headers: { 'Accept': 'application/json' }, mode: 'cors' });
        if(!res.ok){ const err = await res.text(); console.error('Search failed', res.status, err); throw new Error(`HTTP ${res.status}`); }
        const text = await res.text();
        try { return JSON.parse(text); } catch (e) { console.error('Invalid JSON from API', text); throw new Error('Invalid JSON'); }
      }

      function clearMarkers(){
        markers.forEach(m => { try{ map.removeLayer(m); }catch{} });
        markers = []; markersById.clear();
      }
      function setBanner(text){ const b = document.getElementById('banner'); if(text){ b.textContent = text; b.classList.add('show'); } else { b.classList.remove('show'); b.textContent=''; } requestAnimationFrame(()=>map.invalidateSize()); }
      function setMapLoading(on){ const ov = document.getElementById('mapOverlay'); if(on){ ov.classList.add('show'); } else { ov.classList.remove('show'); } }
      let selectedId = null;
      function setMarkerSelected(id, on){
        const m = markersById.get(id);
        if(!m) return;
        const el = m.getElement ? m.getElement() : m._icon;
        if(el){ el.classList.toggle('selected', !!on); }
        if(on && m.bringToFront) m.bringToFront();
      }
      function selectById(id, pan=true){
        selectedId = id;
        highlightRow(id);
        setMarkerSelected(id, true);
        markersById.forEach((_m, mid) => { if(mid !== id) setMarkerSelected(mid, false); });
        const m = markersById.get(id);
        if(m){ if(pan){ map.setView(m.getLatLng(), Math.max(map.getZoom(), 12)); } m.openPopup(); }
      }
      function renderRows(items){
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        for(const it of items){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td><span class="cell">${it.id}</span></td><td><span class="cell">${it.owner||''}</span></td><td><span class="cell">${it.county||''}</span></td><td><span class="cell">${it.depth_ft??''}</span></td><td class="date-cell"><span class="cell">${it.date_completed||''}</span></td>`;
          tr.tabIndex = 0;
          tr.style.cursor = 'pointer';
          tr.addEventListener('click', () => {
            console.log('Row clicked:', it.id);
            selectById(it.id);
          });
          tr.addEventListener('keydown', (e) => { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); selectById(it.id); }});
          tr.addEventListener('mouseenter', () => {
            setMarkerSelected(it.id, true);
            tr.style.backgroundColor = 'color-mix(in srgb, var(--accent) 15%, var(--panel))';
          });
          tr.addEventListener('mouseleave', () => {
            if(selectedId !== it.id) setMarkerSelected(it.id, false);
            if(selectedId !== it.id) tr.style.backgroundColor = '';
          });
          tr.dataset.id = it.id;
          tbody.appendChild(tr);
        }
        if(items.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="5" style="color:var(--muted);padding:16px">No results. Try widening your filters or moving the map.</td>';
          tbody.appendChild(tr);
        }
      }
      function renderMarkers(items){
        clearMarkers();
        const pts = [];
        for(const it of items){
          if(it.lat && it.lon){
            const html = `<strong>${it.id}</strong><br/>${it.owner||''}<br/>${it.county||''}<br/>Depth: ${it.depth_ft??''} ft<br/>Completed: ${it.date_completed||''}`;
            const m = L.marker([it.lat, it.lon]).bindPopup(html);
            m.on('click', () => selectById(it.id, false));
            m.addTo(map);
            markers.push(m);
            markersById.set(it.id, m);
            pts.push([it.lat, it.lon]);
          }
        }
        if(pts.length && !suppressFitBounds){
          const b = L.latLngBounds(pts);
          setTimeout(() => { map.invalidateSize(); map.fitBounds(b.pad(0.2)); }, 0);
        }
        suppressFitBounds = false;
      }
      function highlightRow(id){
        const rows = document.querySelectorAll('#rows tr');
        rows.forEach(r => {
          const isActive = r.dataset.id === String(id);
          r.classList.toggle('row-active', isActive);
          if(isActive){
            r.style.backgroundColor = 'color-mix(in srgb, var(--panel) 85%, var(--accent) 15%)';
          } else if(selectedId !== r.dataset.id) {
            r.style.backgroundColor = '';
          }
        });
        const target = Array.from(rows).find(r => r.dataset.id === String(id));
        if(target){ target.scrollIntoView({ block: 'nearest' }); }
        // keep header alignment consistent by forcing layout
        const table = document.querySelector('table');
        if(table){ table.style.tableLayout='fixed'; }
        // ensure marker highlight reflects row selection
        markersById.forEach((_m, mid) => { const el = markersById.get(mid)?._icon || markersById.get(mid)?.getElement?.(); if(el){ el.classList.toggle('selected', String(mid)===String(id)); }});
      }

      async function geocodeAndCenter(q){
        if(!q) return;
        try{
          setMapLoading(true); setBanner('');
          const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&q=${encodeURIComponent(q + ', Texas')}`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          const data = await res.json();
          if(Array.isArray(data) && data.length){
            const { lat, lon } = data[0];
            selectedCenter = L.latLng(parseFloat(lat), parseFloat(lon));
            map.setView(selectedCenter, 12);
            if(centerMarker){ map.removeLayer(centerMarker); }
            centerMarker = L.marker(selectedCenter, { opacity: 0.7 }).addTo(map).bindPopup('Search center');
            suppressFitBounds = true;
            await runSearch();
          } else {
            setBanner('Could not find that address. Try a more specific query.');
          }
        } catch (e){
          setBanner('Geocoding failed. Please try again.');
        } finally {
          setMapLoading(false);
        }
      }

      function gatherFilters(){
        const form = document.getElementById('filters');
        const data = Object.fromEntries(new FormData(form).entries());
        const params = {
          county: data.county || undefined,
          depth_min: data.depth_min || undefined,
          depth_max: data.depth_max || undefined,
          date_from: data.date_from || undefined,
          date_to: data.date_to || undefined,
          limit: 100,
        };
        const useRadius = document.getElementById('use_radius').checked;
        const r = Number(data.radius_m || 0);
        if(useRadius && !Number.isNaN(r) && r > 0){
          const c = selectedCenter || map.getCenter();
          params.lat = c.lat;
          params.lon = c.lng;
          params.radius_m = r;
        }
        return params;
      }

      async function runSearch(){
        setStatus('Loading...', true);
        const params = gatherFilters();
        const useRadius = document.getElementById('use_radius').checked;
        if(useRadius && params.radius_m){
          // Draw/update radius circle
          if(radiusCircle){ map.removeLayer(radiusCircle); }
          const c = selectedCenter || map.getCenter();
          radiusCircle = L.circle([c.lat, c.lng], { radius: params.radius_m, color: '#3b82f6', weight: 1, fillOpacity: 0.05 }).addTo(map);
        } else {
          if(radiusCircle){ map.removeLayer(radiusCircle); radiusCircle = null; }
        }
        let items = [];
        try{
          items = await fetchResults(params); setBanner('');
        }catch(e){ console.error(e); setBanner(`Error loading results. ${e && e.message ? e.message : ''}`); items=[]; }
        // Support both array and {items: [...]} shapes
        const rows = Array.isArray(items) ? items : (items.items || []);
        allRows = rows.slice(); // base
        // Sorting defaults
        const cmp = (a,b,key)=>{
          const va = (a[key] ?? ''), vb = (b[key] ?? '');
          if(key==='depth_ft'){ const na=Number(va)||0, nb=Number(vb)||0; return na-nb; }
          return String(va).localeCompare(String(vb));
        };
        sortKey = 'date_completed'; sortDir = 'desc';
        allRows.sort((a,b)=>{ const c=cmp(a,b,sortKey); return sortDir==='asc'? c : -c; });
        page = 1; updateSortIndicators(); renderPage();
        renderMarkers(allRows);
        if(useRadius && params.radius_m){
          setStatus(rows.length ? `${rows.length} results within ${params.radius_m} m` : 'No results for this radius');
        } else {
          setStatus(rows.length ? `${rows.length} results` : 'No results');
        }
        // Persist filters to URL for share/refresh
        const qs = new URLSearchParams();
        Object.entries(params).forEach(([k,v]) => { if(v!=null && v!=='') qs.set(k, String(v)); });
        const url = `${location.pathname}?${qs.toString()}`;
        history.replaceState(null, '', url);
      }
      function applyQueryDefaults(){
        const params = new URLSearchParams(window.location.search);
        const county = params.get('county');
        if(county){ document.querySelector('input[name="county"]').value = county; }
        const df = params.get('date_from'); if(df) document.querySelector('input[name="date_from"]').value = df;
        const dt = params.get('date_to'); if(dt) document.querySelector('input[name="date_to"]').value = dt;
        const lat = params.get('lat'); const lon = params.get('lon'); const rad = params.get('radius_m');
        if(lat && lon && rad){
          document.getElementById('use_radius').checked = true;
          document.querySelector('input[name="radius_m"]').value = rad;
          selectedCenter = L.latLng(parseFloat(lat), parseFloat(lon));
          map.setView(selectedCenter, 12);
        }
      }
      document.getElementById('filters').addEventListener('submit', (e) => { e.preventDefault(); runSearch().catch(() => setStatus('Error loading')); });
      // Auto-run on filter changes with debounce
      let t;
      const deb = (fn, ms=300) => (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
      ['county','depth_min','depth_max','date_from','date_to','radius_m'].forEach(n => {
        const el = document.querySelector(`[name="${n}"]`);
        if(el){ el.addEventListener('input', deb(() => runSearch().catch(() => setStatus('Error loading')))); }
      });
      document.getElementById('reset').addEventListener('click', () => { (document.getElementById('filters')).reset(); setStatus('Ready'); renderRows([]); clearMarkers(); });
      // Sorting interactions
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key'); if(!key) return;
          if(sortKey===key){ sortDir = sortDir==='asc'?'desc':'asc'; } else { sortKey=key; sortDir='asc'; }
          const toNum = v => (v==null || v==='') ? null : Number(v);
          allRows.sort((a,b)=>{
            let va=a[key], vb=b[key];
            if(key==='depth_ft'){ va=toNum(va)||0; vb=toNum(vb)||0; }
            const c = String(va).localeCompare(String(vb), undefined, { numeric: true });
            return sortDir==='asc'? c : -c;
          });
          page=1; updateSortIndicators(); renderPage();
        });
      });
      // Pagination
      const prev = document.getElementById('prev'), next = document.getElementById('next');
      prev && prev.addEventListener('click', () => { if(page>1){ page--; renderPage(); }});
      next && next.addEventListener('click', () => { const pages = Math.max(1, Math.ceil(allRows.length/pageSize)); if(page<pages){ page++; renderPage(); }});
      // Geocode button and Enter key in address field
      const addrInput = document.querySelector('input[name="addr"]');
      document.getElementById('geocode').addEventListener('click', async () => {
        const q = addrInput && 'value' in addrInput ? addrInput.value.trim() : '';
        await geocodeAndCenter(q);
      });
      addrInput && addrInput.addEventListener('keydown', async (e) => {
        if(e.key === 'Enter') { e.preventDefault(); const q = addrInput.value.trim(); await geocodeAndCenter(q); }
      });
      applyQueryDefaults();
      runSearch().catch(() => setStatus('Error loading'));
      map.on('click', (e) => {
        selectedCenter = e.latlng;
        map.setView(e.latlng, Math.max(map.getZoom(), 12));
        if(document.getElementById('use_radius').checked){ suppressFitBounds = true; runSearch(); }
      });
      document.getElementById('use_radius').addEventListener('change', () => { runSearch(); });
      const clusterToggle = document.getElementById('use_cluster');
      if(clusterToggle){ clusterToggle.addEventListener('change', () => { renderMarkers(allRows); }); }
      // Fetch as-of for footer
      (async () => {
        try{
          const res = await fetch(new URL('/v1/meta', API));
          const j = await res.json();
          if(j && j.as_of){ document.querySelector('footer').innerHTML = `SDR as-of ${j.as_of}. Contains data from TWDB SDR.`; const asof=document.getElementById('asof'); if(asof) asof.textContent=`As-of ${j.as_of}`; }
        }catch{}
      })();
      // Export CSV
      const exportBtn = document.getElementById('exportCsv');
      if(exportBtn){
        exportBtn.addEventListener('click', async () => {
          try{
            exportBtn.disabled = true; const prev = exportBtn.textContent; exportBtn.textContent = 'Exporting…';
            const params = gatherFilters();
            const url = new URL('/v1/search.csv', API);
            Object.entries(params).forEach(([k,v]) => { if(v!=null && v!=='') url.searchParams.set(k, String(v)); });
            const res = await fetch(url, { mode: 'cors' });
            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const ts = new Date().toISOString().replace(/[-:T]/g,'').slice(0,15);
            a.download = `tx_wells_${ts}.csv`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
            exportBtn.textContent = prev; exportBtn.disabled = false;
          }catch(e){ console.error('CSV export failed', e); setBanner('CSV export failed. Please try again.'); exportBtn.disabled = false; exportBtn.textContent = 'Export CSV'; }
        });
      }

      // Export PDF
      const exportPdfBtn = document.getElementById('exportPdf');
      if(exportPdfBtn){
        exportPdfBtn.addEventListener('click', async () => {
          try{
            exportPdfBtn.disabled = true; const prev = exportPdfBtn.textContent; exportPdfBtn.textContent = 'Exporting…';
            const params = gatherFilters();
            const url = new URL('/v1/reports', API);
            url.searchParams.set('format','pdf');
            Object.entries(params).forEach(([k,v]) => { if(v!=null && v!=='') url.searchParams.set(k, String(v)); });
            const res = await fetch(url, { mode: 'cors' });
            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const ts = new Date().toISOString().replace(/[-:T]/g,'').slice(0,15);
            a.download = `tx_wells_${ts}.pdf`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
            exportPdfBtn.textContent = prev; exportPdfBtn.disabled = false;
          }catch(e){ console.error('PDF export failed', e); setBanner('PDF export failed. Please try again.'); exportPdfBtn.disabled = false; exportPdfBtn.textContent = 'Export PDF'; }
        });
      }

      // Theme toggle
      const themeBtn = document.getElementById('theme');
      if(themeBtn){
        const saved = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', saved);
        themeBtn.addEventListener('click', () => {
          const cur = document.documentElement.getAttribute('data-theme') || 'dark';
          const next = cur==='dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
        });
      }
    </script>
  </body>
  </html>


