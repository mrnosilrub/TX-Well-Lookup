---
const publicApi = import.meta.env.PUBLIC_API_URL || '';
---
<section class="card" data-api={publicApi}>
  <h3 style="margin-top:0">Search</h3>
  <form id="search-form" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
    <input id="q" name="q" placeholder="Search wells (try: Sample)" style="flex:1 1 220px;min-width:200px;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb" />
    <input id="depthMin" name="depthMin" type="number" placeholder="Min depth (ft)" style="flex:0 0 160px;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb" />
    <input id="depthMax" name="depthMax" type="number" placeholder="Max depth (ft)" style="flex:0 0 160px;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb" />
    <button class="btn" type="submit" style="flex:0 0 auto">Search</button>
  </form>
  <div id="results" style="margin-top:12px"></div>
  <script is:inline>
    const form = document.getElementById('search-form');
    const container = document.currentScript.closest('section');
    const results = document.getElementById('results');
    const inputQ = document.getElementById('q');
    const inputMin = document.getElementById('depthMin');
    const inputMax = document.getElementById('depthMax');
    let currentItems = [];
    const setStatus = (msg) => {
      results.innerHTML = `<small>${msg}</small>`;
    };
    async function fetchItems() {
      try {
        const apiBase = (container?.dataset.api || '').toString().trim();
        const primary = apiBase
          ? new URL('v1/search', apiBase.endsWith('/') ? apiBase : apiBase + '/').toString()
          : new URL('/v1/search', window.location.origin).toString();
        let res = await fetch(primary, { cache: 'no-store' });
        if (!res.ok) {
          // Fallback to static stub when API/proxy is unavailable
          const stub = new URL('api/search.json', document.baseURI).toString();
          res = await fetch(stub, { cache: 'no-store' });
        }
        if (!res.ok) throw new Error('bad status');
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : Array.isArray(data) ? data : [];
        return items;
      } catch (err) {
        console.error('search fetch failed', err);
        return [];
      }
    }
    function applyFilters(items) {
      const q = (document.getElementById('q').value || '').toLowerCase();
      const depthMin = parseFloat(document.getElementById('depthMin').value || '');
      const depthMax = parseFloat(document.getElementById('depthMax').value || '');
      return items.filter((it) => {
        const matchesQ = !q || `${it.name} ${it.county}`.toLowerCase().includes(q);
        const matchesMin = isNaN(depthMin) || (it.depth_ft ?? 0) >= depthMin;
        const matchesMax = isNaN(depthMax) || (it.depth_ft ?? 0) <= depthMax;
        return matchesQ && matchesMin && matchesMax;
      });
    }
    function ensureMap(items) {
      if (window.__tx_map) {
        window.__tx_map.setItems(items);
        return;
      }
      const onReady = () => {
        window.__tx_map?.setItems(items);
        window.removeEventListener('tx_map_ready', onReady);
      };
      window.addEventListener('tx_map_ready', onReady);
    }
    function render(items) {
      items = applyFilters(items);
      if (!items.length) {
        setStatus('No results.');
        ensureMap([]);
        return;
      }
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.padding = '0';
      ul.style.margin = '0';
      items.forEach((it) => {
        const li = document.createElement('li');
        li.style.padding = '10px 0';
        li.style.borderBottom = '1px solid #eee';
        const gwdb = it.gwdb_depth_ft ? `<span class="chip" style="background:#ecfeff;border:1px solid #a5f3fc;color:#083344;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:11px">GWDB</span>` : '';
        li.innerHTML = `
          <strong><a href="well/${it.id}/">${it.name}</a></strong>
          ${gwdb}
          <div><small>${it.county} County • Depth: ${it.depth_ft} ft${it.gwdb_depth_ft ? ` • GWDB: ${it.gwdb_depth_ft} ft` : ''}${it.aquifer ? ` • Aquifer: ${it.aquifer}` : ''}${it.gcd ? ` • GCD: ${it.gcd}` : ''}</small></div>
          <div style="margin-top:6px"><button data-id="${it.id}" class="btn" style="padding:6px 10px">Fly to</button></div>
        `;
        ul.appendChild(li);
      });
      results.innerHTML = '';
      results.appendChild(ul);
      results.querySelectorAll('button[data-id]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const id = btn.getAttribute('data-id');
          window.__tx_map?.flyToItem(id);
        });
      });
      ensureMap(items);
    }
    // initial load and on submit
    setStatus('Loading…');
    fetchItems().then((items) => { currentItems = items; render(items); ensureMap(items); });
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('Searching…');
      const items = await fetchItems();
      currentItems = items;
      render(items);
    });

    // live filter as you type/change
    const onFilterChange = () => render(currentItems);
    inputQ.addEventListener('input', onFilterChange);
    inputMin.addEventListener('input', onFilterChange);
    inputMax.addEventListener('input', onFilterChange);
  </script>
</section>


