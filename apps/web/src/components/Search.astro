<section class="card">
  <h3 style="margin-top:0">Search</h3>
  <form id="search-form" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input id="q" name="q" placeholder="Search wells..." style="flex:1;min-width:200px;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb" />
    <button class="btn" type="submit">Search</button>
  </form>
  <div id="results" style="margin-top:12px"></div>
  <script is:inline>
    const form = document.getElementById('search-form');
    const results = document.getElementById('results');
    async function fetchItems() {
      try {
        const base = (window.__tx_base || '/').toString().replace(/\/?$/, '/');
        const url = new URL(`${base}api/search.json`, window.location.origin);
        const res = await fetch(url.toString(), { cache: 'no-store' });
        if (!res.ok) throw new Error('bad status');
        const data = await res.json();
        return Array.isArray(data.items) ? data.items : [];
      } catch {
        return [];
      }
    }
    function ensureMap(items) {
      if (window.__tx_map) {
        window.__tx_map.setItems(items);
        return;
      }
      const onReady = () => {
        window.__tx_map?.setItems(items);
        window.removeEventListener('tx_map_ready', onReady);
      };
      window.addEventListener('tx_map_ready', onReady);
    }
    function render(items) {
      if (!items.length) {
        results.innerHTML = '<small>No results.</small>';
        ensureMap([]);
        return;
      }
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.padding = '0';
      ul.style.margin = '0';
      items.forEach((it) => {
        const li = document.createElement('li');
        li.style.padding = '10px 0';
        li.style.borderBottom = '1px solid #eee';
        li.innerHTML = `
          <strong>${it.name}</strong>
          <div><small>${it.county} County â€¢ Depth: ${it.depth_ft} ft</small></div>
          <div style="margin-top:6px"><button data-id="${it.id}" class="btn" style="padding:6px 10px">Fly to</button></div>
        `;
        ul.appendChild(li);
      });
      results.innerHTML = '';
      results.appendChild(ul);
      results.querySelectorAll('button[data-id]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const id = btn.getAttribute('data-id');
          window.__tx_map?.flyToItem(id);
        });
      });
      ensureMap(items);
    }
    // initial load and on submit (no filtering yet; stub just returns all)
    fetchItems().then((items) => { render(items); ensureMap(items); });
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const items = await fetchItems();
      render(items);
    });
  </script>
</section>


